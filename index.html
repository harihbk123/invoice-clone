<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Manager - Hariprasad Sivakumar</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Third-party Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase after library loads
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase library loaded successfully');
                console.log('Available methods:', Object.keys(window.supabase));
            } else {
                console.error('Supabase library failed to load');
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Enhanced Stylesheet -->
    <link rel="stylesheet" href="style.css?v=20250819-084000">
    
    <!-- Auth Check -->
    <script>
        // Check authentication before loading the app
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const loginTime = localStorage.getItem('loginTime');
        
        if (!isLoggedIn || isLoggedIn !== 'true') {
            window.location.href = 'login.html';
        } else if (loginTime) {
            const now = new Date().getTime();
            const loginTimestamp = parseInt(loginTime);
            const hoursDiff = (now - loginTimestamp) / (1000 * 60 * 60);
            
            if (hoursDiff > 24) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('loginTime');
                window.location.href = 'login.html';
            }
        }
    </script>
</head>
<body>
    <!-- App Layout -->
    <div class="app-layout">
        <!-- Enhanced Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Invoice Manager</h2>
                <p class="sidebar-subtitle">Hariprasad S.</p>
            </div>
            
            <!-- Enhanced User Info Section -->
            <div class="user-info">
                <div class="user-profile">
                    <div class="user-avatar">HS</div>
                    <div class="user-details">
                        <h4>Hariprasad S.</h4>
                        <p>üëã Welcome back!</p>
                    </div>
                </div>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="#" class="nav-link active" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a></li>
                <li><a href="#" class="nav-link" data-page="invoices">
                    <span class="nav-icon">üìÑ</span>
                    <span>Invoices</span>
                </a></li>
                <li><a href="#" class="nav-link" data-page="clients">
                    <span class="nav-icon">üë•</span>
                    <span>Clients</span>
                </a></li>
                <li><a href="#" class="nav-link" data-page="expenses">
                    <span class="nav-icon">üí∞</span>
                    <span>Expenses</span>
                </a></li>
                <li><a href="#" class="nav-link" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a></li>
                <li><a href="#" class="nav-link" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a></li>
            </ul>
            
            <!-- Modern Sidebar Footer with Logout -->
            <div class="sidebar-footer">
                <button class="logout-btn-compact" id="logout-btn" onclick="logout()" title="Sign out from your account">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <div>
                        <h1>Dashboard</h1>
                        <p style="color: var(--text-muted); margin: 8px 0 0 0; font-size: 14px;">
                            Track your business performance and financial metrics
                        </p>
                    </div>
                    <div class="header-actions">
                        <div class="notification-btn" style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-secondary); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.2s ease;">
                            <span>üîî</span>
                            <span style="position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; background: var(--danger); color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</span>
                        </div>
                        <button class="btn btn--primary" id="create-invoice-btn">
                            <span>+</span>
                            <span>Create Invoice</span>
                        </button>
                    </div>
                </div>

                <!-- Enhanced Metrics Cards -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="stat-header">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-trend up">
                                <span>‚Üë</span>
                                <span>12.5%</span>
                            </div>
                        </div>
                        <div class="metric-value">‚Çπ0</div>
                        <div class="metric-label">Total Earnings</div>
                        <div class="stat-footer">
                            <span>üìÖ</span>
                            <span>Updated just now</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-header">
                            <div class="stat-icon success">üë•</div>
                            <div class="stat-trend up">
                                <span>‚Üë</span>
                                <span>2 new</span>
                            </div>
                        </div>
                        <div class="metric-value">0</div>
                        <div class="metric-label">Total Clients</div>
                        <div class="stat-footer">
                            <span>‚ú®</span>
                            <span>Active & growing</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">üìÑ</div>
                            <div class="stat-trend up">
                                <span>‚Üë</span>
                                <span>8.3%</span>
                            </div>
                        </div>
                        <div class="metric-value">0</div>
                        <div class="metric-label">Total Invoices</div>
                        <div class="stat-footer">
                            <span>‚è±Ô∏è</span>
                            <span>3 pending approval</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-header">
                            <div class="stat-icon info">üìä</div>
                            <div class="stat-trend down">
                                <span>‚Üì</span>
                                <span>3.2%</span>
                            </div>
                        </div>
                        <div class="metric-value">‚Çπ0</div>
                        <div class="metric-label">Average Monthly</div>
                        <div class="stat-footer">
                            <span>üìà</span>
                            <span>Based on 12 months</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Monthly Earnings Trend</h3>
                            <div class="chart-actions">
                                <button class="chart-btn">Daily</button>
                                <button class="chart-btn active">Monthly</button>
                                <button class="chart-btn">Yearly</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 300px; background: linear-gradient(180deg, rgba(94, 114, 228, 0.02) 0%, transparent 100%); border-radius: 12px; padding: 24px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Client Revenue Distribution</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="clientChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Recent Invoices -->
                <div class="recent-invoices">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 24px 24px 0;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0;">Recent Invoices</h3>
                        <a href="#" style="color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: gap 0.2s ease;">
                            View All
                            <span>‚Üí</span>
                        </a>
                    </div>
                    <div class="table-container">
                        <table class="invoices-table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-invoices-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices Page -->
            <div id="invoices-page" class="page">
                <!-- Content will be populated by renderInvoices() function -->
                <div class="loading-placeholder" style="text-align: center; padding: 50px; color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: 16px;">üìÑ</div>
                    <h3>Loading Invoices...</h3>
                    <p>Please wait while we load your invoice data</p>
                </div>
            </div>

            <!-- Clients Page -->
            <div id="clients-page" class="page">
                <!-- Content will be populated by renderClients() function -->
                <div class="loading-placeholder" style="text-align: center; padding: 50px; color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: 16px;">üë•</div>
                    <h3>Loading Clients...</h3>
                    <p>Please wait while we load your client data</p>
                </div>
            </div>

            <!-- Expenses Page -->
            <div id="expenses-page" class="page">
                <!-- Content will be populated by ExpenseUI class -->
                <div class="loading-placeholder" style="text-align: center; padding: 50px; color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: 16px;">üí∞</div>
                    <h3>Loading Expenses...</h3>
                    <p>Please wait while we load your expense data</p>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics-page" class="page">
                <!-- Content will be populated by renderAnalytics() function -->
                <div class="loading-placeholder" style="text-align: center; padding: 50px; color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: 16px;">üìà</div>
                    <h3>Loading Analytics...</h3>
                    <p>Please wait while we load your analytics data</p>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page">
                <!-- Content will be populated by renderSettings() function -->
                <div class="loading-placeholder" style="text-align: center; padding: 50px; color: var(--text-muted);">
                    <div style="font-size: 24px; margin-bottom: 16px;">‚öôÔ∏è</div>
                    <h3>Loading Settings...</h3>
                    <p>Please wait while we load your settings</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal hidden">
        <div class="modal-content">
            <!-- Modal content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Client Modal -->
    <div id="client-modal" class="modal hidden">
        <div class="modal-content">
            <!-- Modal content will be populated by JavaScript -->
        </div>
    </div>

    

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container">
        <!-- Toast notifications will be added here -->
    </div>

    <!-- Debug Console -->
    <div id="debug-console" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-width: 300px; z-index: 10000; display: none;">
        <div id="debug-output"></div>
        <button onclick="document.getElementById('debug-console').style.display='none'" style="float: right; background: none; border: none; color: white;">√ó</button>
    </div>

    <!-- Load JavaScript with error handling -->
    <script>
        // Debug logging
        console.log('üöÄ Starting to load app.js...');
        let debugLog = [];
        
        function addDebugLog(message) {
            debugLog.push(new Date().toLocaleTimeString() + ': ' + message);
            console.log(message);
            
            // Show debug console if there are errors
            if (message.includes('‚ùå') || message.includes('üö®')) {
                const debugConsole = document.getElementById('debug-console');
                const debugOutput = document.getElementById('debug-output');
                debugOutput.innerHTML = debugLog.slice(-5).join('<br>');
                debugConsole.style.display = 'block';
            }
        }
        
        window.addEventListener('error', function(e) {
            addDebugLog('‚ùå JavaScript Error: ' + e.error?.message);
            addDebugLog('File: ' + e.filename + ' Line: ' + e.lineno);
        });
        
        window.addEventListener('load', function() {
            addDebugLog('‚úÖ Window loaded');
            
            // Check if app initialized
            setTimeout(() => {
                if (typeof window.appData === 'undefined' || !window.appData?.dataLoaded) {
                    addDebugLog('üö® App not initialized, forcing emergency init...');
                    if (typeof window.emergencyInit === 'function') {
                        window.emergencyInit();
                        addDebugLog('‚úÖ Emergency init called');
                    } else if (typeof window.addSampleDataIfEmpty === 'function') {
                        window.addSampleDataIfEmpty();
                        if (typeof renderDashboard === 'function') renderDashboard();
                        addDebugLog('‚úÖ Sample data added');
                    } else {
                        addDebugLog('üîß Running basic emergency fallback...');
                        // Basic emergency fallback
                        window.appData = {
                            totalEarnings: 12500,
                            totalClients: 2,
                            totalInvoices: 2,
                            clients: [
                                { id: 'client-1', name: 'Sample Client', email: 'client@example.com', totalEarnings: 15000 },
                                { id: 'client-2', name: 'Another Client', email: 'another@example.com', totalEarnings: 8500 }
                            ],
                            invoices: [
                                { id: 'HP-2526-001', client: 'Sample Client', amount: 5000, date: '2025-08-01', status: 'Paid', clientId: 'client-1' },
                                { id: 'HP-2526-002', client: 'Another Client', amount: 7500, date: '2025-08-05', status: 'Pending', clientId: 'client-2' }
                            ],
                            dataLoaded: true,
                            settings: { currency: 'INR', taxRate: 18, invoicePrefix: 'HP-2526', profileName: 'Hariprasad Sivakumar' }
                        };
                        if (typeof renderDashboard === 'function') renderDashboard();
                        addDebugLog('‚úÖ Basic emergency init completed');
                    }
                }
            }, 3000);
        });
    </script>
    <script src="app.js?v=20250819-084000" onerror="addDebugLog('‚ùå Failed to load app.js')"></script>
    <script>
        console.log('‚úÖ app.js loaded successfully');
        addDebugLog('‚úÖ app.js script tag processed');
        
        // Additional emergency init fallback
        setTimeout(() => {
            if (typeof window.appData === 'undefined' || !window.appData?.dataLoaded) {
                console.log('‚ö†Ô∏è Final fallback: creating minimal app data');
                window.appData = {
                    dataLoaded: true,
                    totalEarnings: 12500,
                    totalClients: 2,
                    totalInvoices: 2,
                    invoices: [
                        { id: 'HP-2526-001', client: 'Sample Client', amount: 5000, date: '2025-08-01', dueDate: '2025-08-31', status: 'Paid', clientId: 'client-1' },
                        { id: 'HP-2526-002', client: 'Another Client', amount: 7500, date: '2025-08-05', dueDate: '2025-09-05', status: 'Pending', clientId: 'client-2' }
                    ],
                    clients: [
                        { id: 'client-1', name: 'Sample Client', email: 'client@example.com', totalEarnings: 5000 },
                        { id: 'client-2', name: 'Another Client', email: 'another@example.com', totalEarnings: 7500 }
                    ],
                    settings: {
                        currency: 'INR',
                        taxRate: 18,
                        invoicePrefix: 'HP-2526',
                        profileName: 'Hariprasad Sivakumar'
                    }
                };
                if (typeof renderDashboard === 'function') renderDashboard();
                addDebugLog('‚úÖ Emergency data created');
            }
        }, 5000);
    </script>
</body>
</html>